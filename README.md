# AceClass - 補課影片管理系統

## 安全作用域存取與沙箱權限問題修復指南

當您使用 AceClass 時，如果在外部驅動器上遇到權限問題，請參考以下指南。

### 目前已修復的問題

1. **書籤權限管理** - 修復了安全作用域存取權限的獲取、保存和使用方式，確保書籤有適當的讀寫權限。
2. **避免在視圖更新期間修改狀態** - 修復了"Publishing changes from within view updates is not allowed"警告，通過將狀態更新移到主線程的異步操作中。
3. **後台文件操作** - 所有文件讀寫操作都移到了後台線程，以避免凍結UI。
4. **影片資源訪問** - 改進了訪問外部驅動器上影片文件的代碼。

### 仍需注意的事項

1. **外部驅動器格式** - 確保外部驅動器格式支持macOS完整讀寫權限（推薦APFS或Mac OS Extended）。
2. **完整磁盤訪問** - 為了最佳體驗，請在"系統設定 > 隱私權與安全性 > 完整磁碟取用權限"中授予AceClass權限。

### 如果仍然遇到問題

如果在外部驅動器上仍然遇到"您沒有權限保存文件"或"無法啟動安全作用域存取"的錯誤，嘗試以下方法：

1. **重新選擇資料夾** - 重新選擇課程資料夾，這將創建新的安全作用域書籤。
2. **確認寫入權限** - 在Finder中右鍵點擊課程資料夾，選擇"取得資訊"，確認您有"讀與寫"權限。
3. **檢查系統偏好設定** - 確認隱私權與安全性設定允許AceClass訪問外部驅動器。
4. **嘗試不同位置** - 如果特定驅動器持續出現問題，可以嘗試在本機硬盤上的文件夾。

### 技術說明

AceClass使用macOS的安全作用域書籤(Security-Scoped Bookmarks)系統來獲取對用戶選定文件夾的持久訪問權限。這是macOS沙盒應用程序訪問用戶選定內容的標準方法。

主要步驟：
1. 用戶選擇文件夾時，創建安全作用域書籤並保存到UserDefaults
2. 應用程序啟動時，恢復書籤並啟動安全作用域資源訪問
3. 維持對主文件夾的訪問權限，直到應用關閉
4. 對影片文件進行單獨的安全作用域訪問以支持播放
