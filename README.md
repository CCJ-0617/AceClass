# AceClass - 補課影片管理系統

## 安全作用域存取與沙箱權限問題修復指南

當您使用 AceClass 時，這份指南將幫助您了解應用程序的權限需求和數據存儲方式。

### 應用程序權限需求說明

AceClass 現在採用了更簡化的權限模型：

1. **課程資料夾的讀寫權限** - 應用程序會請求您選擇的課程資料夾的讀寫權限，以支持元數據寫入外部驅動器。

2. **元數據混合存儲** - 所有元數據（如觀看狀態、筆記等）都存儲在應用程序的沙盒目錄中，同時也會嘗試寫入到外部驅動器（如可能）。

3. **靈活的存儲選項** - 默認情況下會嘗試將元數據寫入外部驅動器，但即使寫入外部驅動器失敗，應用程序也能正常運作，因為本地始終有一份備份。

### 已實現的解決方案

應用程序現在使用混合存儲策略，以提供靈活的數據管理：

1. **本地元數據存儲** - 所有課程和影片的元數據（如觀看狀態、註解）都會存儲在本地應用支持目錄中：
   ```
   ~/Library/Containers/ChenChiJiun.AceClass/Data/Library/Application Support/AceClass/Courses/
   ```

2. **嘗試外部寫入** - 應用程序會嘗試將元數據同時寫入外部驅動器（如權限允許），以便在不同設備間共享數據。

3. **改進的權限管理** - 在請求安全作用域書籤時請求讀寫權限，以支持將元數據寫入外部驅動器。

### 目前已修復的問題

1. **書籤權限管理** - 修復了安全作用域存取權限的獲取、保存和使用方式，請求讀寫權限以支持完整功能。
2. **避免在視圖更新期間修改狀態** - 修復了"Publishing changes from within view updates is not allowed"警告。
3. **後台文件操作** - 所有文件讀寫操作都移到了後台線程，以避免凍結UI。
4. **影片資源訪問** - 改進了訪問外部驅動器上影片文件的代碼。
5. **元數據存儲位置** - 將需要寫入的元數據移至應用沙盒內的本地存儲。
6. **移除完整磁碟權限需求** - 應用程序不再需要或請求「完整磁碟存取權限」，只使用標準的安全作用域書籤機制。

### 技術說明

AceClass使用macOS的安全作用域書籤(Security-Scoped Bookmarks)系統來獲取對用戶選定文件夾的持久訪問權限，請求完整的讀寫權限。

主要步驟：
1. 用戶選擇課程資料夾時，創建具有讀寫權限的安全作用域書籤並保存到UserDefaults
2. 應用程序啟動時，恢復書籤並啟動安全作用域資源訪問
3. 維持對主資料夾的讀寫權限，直到應用關閉
4. 所有元數據優先保存在本地沙盒目錄，同時嘗試寫入到外部驅動器（最大努力原則）
5. 影片播放使用讀取權限從外部驅動器加載

### 已知限制

1. **數據同步** - 即使應用嘗試將元數據寫入外部驅動器，也不保證在不同設備間自動同步。
2. **權限依賴** - 如果用戶未授予寫入權限，外部驅動器的元數據將無法更新，但本地元數據仍然可用。
3. **控制寫入行為** - 可透過調整 `LocalMetadataStorage.shouldAttemptWriteToExternalDrives` 屬性控制是否嘗試寫入外部驅動器。

### 如需更多幫助

如果您需要進一步的協助或遇到其他問題，請參考macOS沙盒應用程序開發文檔或聯繫開發者支持。
